<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - PDFs Musae Bot</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container { max-width: 800px; margin: 0 auto; padding: 2rem; }
        .login-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 400px;
            margin: 4rem auto;
        }
        .login-box h2 { margin-bottom: 1rem; }
        .login-box input { margin-bottom: 1rem; }
        .pdf-list { margin-top: 2rem; }
        .pdf-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            border: 1px solid var(--color-border);
        }
        .pdf-item-info { flex: 1; }
        .pdf-item-info strong { display: block; margin-bottom: 0.25rem; }
        .pdf-item-info span { font-size: 0.85rem; color: var(--color-text-muted); }
        .btn-logout { margin-left: 1rem; background: #dc2626; }
        .btn-logout:hover { background: #b91c1c; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--color-text-muted); }
    </style>
</head>
<body>
    <div class="admin-container">
        <div id="loginSection" class="login-box">
            <h2>üîê Acesso Admin</h2>
            <p style="color: var(--color-text-muted); margin-bottom: 1rem;">Digite a senha para acessar os PDFs salvos.</p>
            <input type="password" id="adminPassword" placeholder="Senha" style="width: 100%; padding: 0.75rem 1rem; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text); font-size: 1rem; margin-bottom: 1rem;">
            <button type="button" class="btn btn-primary" id="loginBtn">Entrar</button>
            <p id="loginError" style="color: #dc2626; margin-top: 0.5rem; display: none;">Senha incorreta.</p>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="admin-header">
                <h1>üìÑ PDFs Salvos - Musae Bot</h1>
                <button type="button" class="btn btn-logout" id="logoutBtn">Sair</button>
            </div>
            <div id="pdfList" class="pdf-list"></div>
        </div>
    </div>

    <script>
        const loginSection = document.getElementById('loginSection');
        const adminSection = document.getElementById('adminSection');
        const pdfList = document.getElementById('pdfList');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminPassword = document.getElementById('adminPassword');
        const loginError = document.getElementById('loginError');

        loginBtn.addEventListener('click', async () => {
            loginError.style.display = 'none';
            const res = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ password: adminPassword.value })
            });
            const data = await res.json();
            if (data.success) {
                loginSection.style.display = 'none';
                adminSection.style.display = 'block';
                loadPdfs();
            } else {
                loginError.style.display = 'block';
            }
        });

        adminPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        logoutBtn.addEventListener('click', async () => {
            await fetch('/api/admin/logout', { method: 'POST', credentials: 'include' });
            loginSection.style.display = 'block';
            adminSection.style.display = 'none';
            adminPassword.value = '';
            loginError.style.display = 'none';
        });

        async function loadPdfs() {
            try {
                const res = await fetch('/api/pdfs', { credentials: 'include' });
                if (!res.ok) {
                    pdfList.innerHTML = '<div class="empty-state">Erro ao carregar. Fa√ßa login novamente.</div>';
                    return;
                }
                const data = await res.json();

                if (!data.files || data.files.length === 0) {
                    pdfList.innerHTML = '<div class="empty-state">Nenhum PDF salvo ainda.</div>';
                    return;
                }

                const registrosMap = {};
            (data.registros || []).forEach(r => {
                registrosMap[r.arquivo] = r;
            });

            pdfList.innerHTML = data.files.map(f => {
                const reg = registrosMap[f.nome] || {};
                const dataFormatada = new Date(f.data).toLocaleString('pt-BR');
                const assinante = reg.assinante || '‚Äî';
                return `
                    <div class="pdf-item">
                        <div class="pdf-item-info">
                            <strong>${assinante}</strong>
                            <span>${f.nome} ‚Ä¢ ${dataFormatada}</span>
                        </div>
                        <a href="/api/pdf/${encodeURIComponent(f.nome)}" class="btn btn-download" download="${f.nome}">Baixar PDF</a>
                    </div>
                `;
            }).join('');
            } catch (err) {
                pdfList.innerHTML = '<div class="empty-state">Erro ao carregar os PDFs.</div>';
            }
        }
    </script>
</body>
</html>
